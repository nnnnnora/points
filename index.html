<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒŸ å¿«ä¹ç­çº§ç§¯åˆ†æ¦œ ğŸŒŸ</title>
    <style>
        /* --- æ•´ä½“é£æ ¼è®¾ç½® --- */
        :root {
            --primary-color: #FF9A9E; /* æŸ”å’Œç²‰ */
            --secondary-color: #FECFEF; /* æµ…ç²‰ */
            --accent-color: #84fab0; /* è–„è·ç»¿ */
            --bg-color: #f6f9fc;
            --card-bg: #ffffff;
            --text-color: #4a4a4a;
        }

        body {
            font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(#e0e0e0 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #ff6b6b;
            font-size: 2.5em;
            text-shadow: 2px 2px 0px #ffeaa7;
            margin-bottom: 30px;
        }

        /* --- é¡¶éƒ¨æ§åˆ¶æ  --- */
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        button {
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        button:active {
            transform: scale(0.95);
        }

        .btn-import { background-color: #4facfe; color: white; }
        .btn-add-rule { background-color: #43e97b; color: white; }
        .btn-undo { background-color: #ff9f43; color: white; } /* æ–°å¢æ’¤é”€æŒ‰é’®é¢œè‰² */
        .btn-reset { background-color: #a8a8a8; color: white; }

        /* --- å­¦ç”Ÿå¡ç‰‡ç½‘æ ¼ --- */
        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .student-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            position: relative;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            transition: transform 0.3s;
            border: 3px solid transparent;
            cursor: pointer;
            user-select: none; /* é˜²æ­¢åŒå‡»é€‰ä¸­æ–‡å­— */
        }

        .student-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-color);
        }

        .avatar {
            font-size: 50px;
            margin-bottom: 10px;
            display: block;
            line-height: 1.2;
        }

        .name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }

        .score-badge {
            background-color: #fff4e6;
            color: #ff9f43;
            padding: 5px 15px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 1.2em;
            display: inline-block;
        }

        /* --- å¼¹çª—æ ·å¼ --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            padding: 30px;
            border-radius: 25px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal h2 { margin-top: 0; color: #333; }

        textarea, input, select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #eee;
            border-radius: 10px;
            box-sizing: border-box;
            font-size: 16px;
        }

        textarea:focus, input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .top-three {
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 24px;
            transform: rotate(15deg);
        }

        /* æ“ä½œé¢æ¿ */
        .action-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .action-btn {
            padding: 10px;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            justify-content: center;
            flex-direction: column;
            line-height: 1.4;
        }
        .btn-plus { background-color: #43e97b; }
        .btn-minus { background-color: #ff6b6b; }

    </style>
</head>
<body>

    <h1>ğŸˆ å¿«ä¹æˆé•¿ç§¯åˆ†æ¦œ ğŸˆ</h1>

    <div class="controls">
        <button class="btn-import" onclick="openModal('importModal')">ğŸ“ å¯¼å…¥åå•</button>
        <button class="btn-add-rule" onclick="openModal('ruleModal')">â• è§„åˆ™è®¾ç½®</button>
        <button class="btn-undo" onclick="undoLastAction()">â†©ï¸ æ’¤é”€ä¸Šä¸€æ­¥</button>
        <button class="btn-reset" onclick="confirmReset()">ğŸ—‘ï¸ é‡ç½®æ•°æ®</button>
    </div>

    <!-- å­¦ç”Ÿåˆ—è¡¨åŒºåŸŸ -->
    <div class="student-grid" id="studentGrid">
        <!-- å­¦ç”Ÿå¡ç‰‡å°†é€šè¿‡JSç”Ÿæˆ -->
    </div>

    <!-- 1. å¯¼å…¥åå•å¼¹çª— -->
    <div id="importModal" class="modal-overlay">
        <div class="modal">
            <h2>ğŸ“ å¯¼å…¥å­¦ç”Ÿåå•</h2>
            <p style="font-size:0.9em; color:#666;">è¯·è¾“å…¥å­¦ç”Ÿå§“åï¼Œæ¯è¡Œä¸€ä¸ª</p>
            <textarea id="nameListInput" rows="8" placeholder="å¼ ä¸‰&#10;æå››&#10;ç‹äº”"></textarea>
            <div class="modal-buttons">
                <button onclick="closeModal('importModal')" style="background:#ccc">å–æ¶ˆ</button>
                <button onclick="importStudents()" class="btn-import">ç¡®è®¤å¯¼å…¥</button>
            </div>
        </div>
    </div>

    <!-- 2. æ“ä½œå¼¹çª— (ç‚¹å‡»å­¦ç”Ÿåå‡ºç°) -->
    <div id="actionModal" class="modal-overlay">
        <div class="modal">
            <h2 id="currentStudentName">æ“ä½œ</h2>
            <div id="quickActions" class="action-panel">
                <!-- å¿«æ·æŒ‰é’®JSç”Ÿæˆ -->
            </div>
            
            <hr style="margin: 20px 0; border:0; border-top:1px dashed #eee;">
            
            <h3>è‡ªå®šä¹‰å˜åŠ¨</h3>
            <input type="text" id="customReason" placeholder="ç†ç”±ï¼ˆå¦‚ï¼šå¸®åŠ©åŒå­¦ï¼‰">
            <input type="number" id="customScore" placeholder="åˆ†å€¼ï¼ˆå¦‚ï¼š2 æˆ– -5ï¼‰">
            
            <div class="modal-buttons">
                <button onclick="closeModal('actionModal')" style="background:#ccc">å–æ¶ˆ</button>
                <button onclick="applyCustomScore()" class="btn-import">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <!-- 3. è§„åˆ™ç®¡ç†å¼¹çª— -->
    <div id="ruleModal" class="modal-overlay">
        <div class="modal">
            <h2>âš™ï¸ è®¾ç½®å¸¸ç”¨åŠ å‡åˆ†é¡¹</h2>
            <p>è¾“å…¥æ ¼å¼ï¼šç†ç”±,åˆ†å€¼ (æ¯è¡Œä¸€ä¸ª)</p>
            <textarea id="rulesInput" rows="8" placeholder="ä½œä¸šå·¥æ•´,2&#10;å›ç­”é—®é¢˜ç§¯æ,1&#10;å…‘æ¢é“…ç¬”,-10&#10;è¿Ÿåˆ°,-2"></textarea>
            <div class="modal-buttons">
                <button onclick="closeModal('ruleModal')" style="background:#ccc">å–æ¶ˆ</button>
                <button onclick="saveRules()" class="btn-add-rule">ä¿å­˜è®¾ç½®</button>
            </div>
        </div>
    </div>

    <script>
        // --- æ•°æ®ç®¡ç† ---
        let students = JSON.parse(localStorage.getItem('class_students')) || [];
        
        // å†å²è®°å½•æ ˆï¼ˆç”¨äºæ’¤é”€ï¼‰
        let historyStack = [];

        // é»˜è®¤è§„åˆ™
        let rules = JSON.parse(localStorage.getItem('class_rules')) || [
            { reason: "ğŸ“š ä½œä¸šå…¨å¯¹", score: 2 },
            { reason: "ğŸ™‹â€â™‚ï¸ ç§¯æä¸¾æ‰‹", score: 1 },
            { reason: "ğŸ§¹ å«ç”Ÿæ ‡å…µ", score: 3 },
            { reason: "ğŸ å…‘æ¢å°é›¶é£Ÿ", score: -10 },
            { reason: "ğŸ å…‘æ¢å…å†™å¡", score: -20 }
        ];

        let currentStudentIndex = null;
        
        // éšæœºå¤´åƒæ•°ç»„ï¼ˆemojiï¼‰
        const avatars = ['ğŸ¦', 'ğŸ¯', 'ğŸ¼', 'ğŸ¨', 'ğŸ°', 'ğŸ¦Š', 'ğŸ¶', 'ğŸ±', 'ğŸ¦„', 'ğŸ¸', 'ğŸµ', 'ğŸ¦‰'];

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            renderStudents();
        };

        // --- å†å²è®°å½•åŠŸèƒ½ (æ’¤é”€) ---
        function saveToHistory() {
            // å°†å½“å‰çŠ¶æ€æ·±æ‹·è´å­˜å…¥å†å²è®°å½•
            if (historyStack.length > 20) historyStack.shift(); // æœ€å¤šå­˜20æ­¥
            historyStack.push(JSON.stringify(students));
        }

        function undoLastAction() {
            if (historyStack.length === 0) {
                alert("å·²ç»æ²¡æœ‰å¯ä»¥æ’¤é”€çš„æ“ä½œå•¦ï¼");
                return;
            }
            // æ¢å¤ä¸Šä¸€æ­¥
            const prevState = historyStack.pop();
            students = JSON.parse(prevState);
            saveData();
            renderStudents();
        }

        // --- æ¸²æŸ“é€»è¾‘ ---
        function renderStudents() {
            const grid = document.getElementById('studentGrid');
            grid.innerHTML = '';

            // æŒ‰åˆ†æ•°æ’åº
            const sortedStudents = [...students].sort((a, b) => b.score - a.score);

            students.forEach((student, index) => {
                const card = document.createElement('div');
                card.className = 'student-card';
                card.onclick = () => openActionModal(index);

                // *** ä¿®å¤éƒ¨åˆ†ï¼šç¡®ä¿ç´¢å¼•æ˜¯æ•´æ•° ***
                // ä½¿ç”¨ Math.floor å–æ•´ï¼Œé˜²æ­¢å‡ºç° undefined
                const avatarIndex = Math.floor(student.id) % avatars.length;
                const avatar = avatars[avatarIndex] || 'ğŸ˜„'; // å¦‚æœä¸‡ä¸€è¿˜æ²¡æ‰¾åˆ°ï¼Œç»™ä¸ªé»˜è®¤ç¬‘è„¸

                // æ’åå¾½ç« 
                let rankBadge = '';
                const rank = sortedStudents.findIndex(s => s.id === student.id);
                if (rank === 0) rankBadge = '<div class="top-three">ğŸ‘‘</div>';
                else if (rank === 1) rankBadge = '<div class="top-three">ğŸ¥ˆ</div>';
                else if (rank === 2) rankBadge = '<div class="top-three">ğŸ¥‰</div>';

                card.innerHTML = `
                    ${rankBadge}
                    <span class="avatar">${avatar}</span>
                    <div class="name">${student.name}</div>
                    <div class="score-badge">${student.score} åˆ†</div>
                `;
                grid.appendChild(card);
            });
        }

        // --- å¯¼å…¥åŠŸèƒ½ ---
        function importStudents() {
            const text = document.getElementById('nameListInput').value;
            if (!text.trim()) return;

            saveToHistory(); // æ“ä½œå‰ä¿å­˜å†å²

            const names = text.split('\n').map(n => n.trim()).filter(n => n);
            
            names.forEach(name => {
                // ç®€å•çš„é˜²é‡åæ£€æŸ¥
                if(!students.find(s => s.name === name)){
                    students.push({
                        // ä½¿ç”¨æ•´æ•°ä½œä¸ºIDçš„ä¸€éƒ¨åˆ†ï¼Œå‡å°‘è®¡ç®—è¯¯å·®
                        id: Date.now() + Math.floor(Math.random() * 1000), 
                        name: name,
                        score: 0
                    });
                }
            });

            saveData();
            renderStudents();
            closeModal('importModal');
        }

        // --- ç§¯åˆ†æ“ä½œé€»è¾‘ ---
        function openActionModal(index) {
            currentStudentIndex = index;
            const student = students[index];
            document.getElementById('currentStudentName').innerText = `ç»™ ${student.name} åŠ å‡åˆ†`;
            
            // ç”Ÿæˆå¿«æ·æŒ‰é’®
            const container = document.getElementById('quickActions');
            container.innerHTML = '';
            
            rules.forEach(rule => {
                const btn = document.createElement('button');
                btn.className = `action-btn ${rule.score > 0 ? 'btn-plus' : 'btn-minus'}`;
                btn.innerHTML = `<span>${rule.reason}</span> <span style="font-size:1.2em"><b>${rule.score > 0 ? '+' : ''}${rule.score}</b></span>`;
                btn.onclick = () => changeScore(rule.score);
                container.appendChild(btn);
            });

            // æ¸…ç©ºè‡ªå®šä¹‰è¾“å…¥
            document.getElementById('customReason').value = '';
            document.getElementById('customScore').value = '';

            openModal('actionModal');
        }

        function changeScore(amount) {
            if (currentStudentIndex === null) return;
            
            // å¦‚æœæ˜¯å‡åˆ†ï¼ˆå…‘æ¢ï¼‰ï¼Œæ£€æŸ¥åˆ†æ•°æ˜¯å¦è¶³å¤Ÿ
            if (amount < 0 && students[currentStudentIndex].score + amount < 0) {
                alert("å“å‘€ï¼Œç§¯åˆ†ä¸å¤Ÿå…‘æ¢è¿™ä¸ªå¥–åŠ±å“¦ï¼åŠ æ²¹èµšç§¯åˆ†å§ï¼");
                return;
            }

            saveToHistory(); // æ“ä½œå‰ä¿å­˜å†å²

            students[currentStudentIndex].score += parseInt(amount);
            saveData();
            renderStudents();
            closeModal('actionModal');
        }

        function applyCustomScore() {
            const score = document.getElementById('customScore').value;
            if (score) {
                changeScore(parseInt(score));
            }
        }

        // --- è§„åˆ™ç®¡ç† ---
        function saveRules() {
            const text = document.getElementById('rulesInput').value;
            const lines = text.split('\n');
            const newRules = [];

            lines.forEach(line => {
                const parts = line.split(/,|ï¼Œ/); // æ”¯æŒä¸­è‹±æ–‡é€—å·
                if (parts.length >= 2) {
                    newRules.push({
                        reason: parts[0].trim(),
                        score: parseInt(parts[1].trim())
                    });
                }
            });

            if (newRules.length > 0) {
                rules = newRules;
                localStorage.setItem('class_rules', JSON.stringify(rules));
                alert('è§„åˆ™å·²æ›´æ–°ï¼');
                closeModal('ruleModal');
            } else {
                alert('æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ç¡®ä¿æ ¼å¼ä¸ºï¼šç†ç”±,åˆ†å€¼');
            }
        }

        // --- é€šç”¨åŠŸèƒ½ ---
        function saveData() {
            localStorage.setItem('class_students', JSON.stringify(students));
        }

        function confirmReset() {
            if(confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å­¦ç”Ÿæ•°æ®å—ï¼Ÿ\n(å¦‚æœç‚¹é”™äº†ï¼Œå¯ä»¥ç«‹å³ç‚¹â€˜æ’¤é”€â€™æ¢å¤)")) {
                saveToHistory(); // æ“ä½œå‰ä¿å­˜å†å²
                students = [];
                saveData();
                renderStudents();
            }
        }

        function openModal(id) {
            document.getElementById(id).style.display = 'flex';
            if(id === 'ruleModal') {
                const ruleText = rules.map(r => `${r.reason},${r.score}`).join('\n');
                document.getElementById('rulesInput').value = ruleText;
            }
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal-overlay')) {
                event.target.style.display = "none";
            }
        }
    </script>
</body>
</html>